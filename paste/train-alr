#!/usr/bin/env jruby -E windows-1250

class Modeling
  # http://mahout.apache.org/users/classification/logistic-regression.html
  def self.require_jars
    %w(
      com.google.guava:guava:16.0
      log4j:log4j:1.2.17
      org.apache.commons:commons-math3:3.2
      org.apache.hadoop:hadoop-core:1.2.1
      org.apache.lucene:lucene-analyzers-common:4.3.0
      org.apache.lucene:lucene-core:4.3.0
      org.apache.mahout:mahout-core:0.8
      org.apache.mahout:mahout-math:0.8
      org.slf4j:slf4j-api:1.6.1
      org.slf4j:slf4j-log4j12:1.6.1
    ).map do |e|
      g, a, v = e.split(':')
      jar = "#{ENV['HOME']}/.m2/repository/#{g.gsub(/\./, '/')}/#{a}/#{v}/#{a}-#{v}.jar"
      system "mvn dependency:get -DremoteRepositories=http://download.java.net/maven2 -Dartifact=#{e}" unless File.exist?(jar)
      require jar
    end
  end

  def initialize(categories = 2, features = 1000)
    @@jars ||= Modeling.require_jars
    @lr = org.apache.mahout.classifier.sgd.AdaptiveLogisticRegression.new(categories, features, org.apache.mahout.classifier.sgd.L1.new)
    @enc = org.apache.mahout.vectorizer.encoders.AdaptiveWordValueEncoder.java_class.constructor(java.lang.String).new_instance('contents').to_java
    @enc.probes = 2
  end

  def hash(words, v = org.apache.mahout.math.RandomAccessSparseVector.new(@lr.numFeatures))
    words.each { |w| @enc.addToVector(w, v) }
    v
  end

  def train(example)
    @lr.train(example[0], example[1]) # e in [actual, instance]
    self
  end

  def close
    @lr.close
  end

  def write(model = '/tmp/model.sgd')
    org.apache.mahout.classifier.sgd.ModelSerializer.writeBinary(model, @lr.best.payload.learner)
  end

  def read(model = open('/tmp/model.sgd').to_inputstream)
    @lr = org.apache.mahout.classifier.sgd.ModelSerializer.readBinary(model, org.apache.mahout.classifier.sgd.CrossFoldLearner.java_class)
    # model.close
  end

  def test
  end
end # the end of class SGD

def run!
  # ARGF.each { |e| $stdout.puts analyzer.tokenize(e).join(' ') }
  sgd = Modeling.new
  sgd.train([1, v = sgd.hash('hello world'.split)])
  sgd.close
  sgd.write
  sgd.read
  sgd.close
end

run! if __FILE__==$0
