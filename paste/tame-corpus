#!/usr/bin/env jruby # called `tame-corpus`
require 'rake'
sources = %w(rrc_pro_22110.csv rrc_ind_31771.csv rrc_pro_2285_labeled_typos.csv)
corpora = %w(corpus-1.csv corpus-2.csv corpus-l.csv).map { |e| File.join(ENV['MAHOUT_WORK'], e) }
options = ["-i 3 -f 4,11", "-i 3 -f 4,11", "-i 4 -l 8 -f 1,3"]
extract = '${MAHOUT_WORK}/comm-text-ext'
c = Integer(ARGV[0]) - 1 # expects 1 or greater.

def x!(*cmd, &blk) block_given? ? (sh cmd.join(' ') do |*a| blk.call(a) end) : (sh cmd.join(' ')) end

x! "s3cmd get s3://${S3_BUCKET}-private/resources/#{sources[c]} #{corpora[c]}" unless File.exist?(corpora[c])
# x! "prep-comm-text #{corpora[c]} -d #{extract} #{options[c]} -o"
x! "prep-comm-text #{corpora[c]} -d #{extract} #{options[c]}"
x! "$HADOOP dfs -rmr #{extract} ${MAHOUT_WORK}/comm-text-seq" do end # rescue on errors.
x! "$HADOOP dfs -put #{extract}/corpus-priors ${MAHOUT_WORK}/comm-text-ext/corpus-priors" do end # rescue on errors.
x! "$HADOOP dfs -put #{extract}/corpus ${MAHOUT_WORK}/comm-text-ext/corpus"
x! "$MAHOUT seqdirectory -i #{extract}/corpus -o ${MAHOUT_WORK}/comm-text-seq -ow -chunk 5"
