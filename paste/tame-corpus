#!/usr/bin/env jruby # called `tame-corpus`
require 'rake'
sources = %w(rrc_pro_22110.csv rrc_ind_31771.csv rrc_pro_2285_labeled_typos.csv)
corpora = %w(corpus-1.csv corpus-2.csv corpus-l.csv).map { |e| File.join(ENV['MAHOUT_WORK'], e) }
fields = ['-i 3 -f 4,11', '-i 3 -f 4,11', '-i 4 -l 8 -f 1,3']
c = ARGV[0].to_i

def x!(*cmd, &blk) block_given? ? (sh cmd.join(' ') do |*a| blk.call(a) end) : (sh cmd.join(' ')) end

x! %W(s3cmd get s3://${S3_BUCKET}-private/resources/#{sources[c]} #{corpora[c]}) unless File.exist?(corpora[c])
x! %W(prep-comm-text #{corpora[c]} -d ${MAHOUT_WORK}/comm-text-ext + #{fields[c]}).join(' ')
x! '$HADOOP dfs -rmr ${MAHOUT_WORK}/comm-text-ext ${MAHOUT_WORK}/comm-text-seq' do end
x! '$HADOOP dfs -put ${MAHOUT_WORK}/comm-text-ext/corpus-priors ${MAHOUT_WORK}/comm-text-ext/corpus-priors'
x! '$HADOOP dfs -put ${MAHOUT_WORK}/comm-text-ext/corpus ${MAHOUT_WORK}/comm-text-ext/corpus'
x! '$MAHOUT seqdirectory -i ${MAHOUT_WORK}/comm-text-ext/corpus -o ${MAHOUT_WORK}/comm-text-seq -ow -chunk 5'
